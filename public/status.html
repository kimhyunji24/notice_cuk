<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìµœì‹  ê¸€ í™•ì¸ ìƒíƒœ</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: #f4f4f9; 
            color: #333; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 800px; 
            margin: 20px auto; 
            background-color: white; 
            padding: 20px 30px; 
            border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        h1 { 
            text-align: center; 
            color: #4a4a4a; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        th, td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid #ddd; 
        }
        th { 
            background-color: #f8f9fa; 
            font-weight: 600;
        }
        .loading { 
            text-align: center; 
            color: #888; 
            padding: 20px;
        }
        .error { 
            text-align: center; 
            color: #dc3545; 
            padding: 20px;
            background-color: #f8d7da;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { 
            text-align: center; 
            color: #28a745; 
            padding: 20px;
            background-color: #d4edda;
            border-radius: 5px;
            margin: 10px 0;
        }
        .refresh-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .refresh-btn:hover {
            background-color: #0056b3;
        }
        .refresh-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .timestamp {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ìµœì‹  ê¸€ í™•ì¸ ìƒíƒœ ğŸ›¸</h1>
        
        <div style="text-align: center; margin: 20px 0;">
            <button id="refresh-btn" class="refresh-btn">ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <table id="status-table">
            <thead>
                <tr>
                    <th>ì‚¬ì´íŠ¸ ë³„ëª…</th>
                    <th>ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸ëœ ê¸€ ì œëª©</th>
                    <th>ê¸€ ë²ˆí˜¸</th>
                </tr>
            </thead>
            <tbody id="status-body">
            </tbody>
        </table>
        
        <div id="loading" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>
        <div id="timestamp" class="timestamp"></div>
    </div>

    <script>
        // API ì„¤ì • - ë¡œì»¬ ê°œë°œ í™˜ê²½ ê°ì§€
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        const API_BASE_URL = '/api';
        const statusApiUrl = `${API_BASE_URL}/status`;

        console.log('API Base URL:', API_BASE_URL);
        console.log('Status API URL:', statusApiUrl);

        // DOM ìš”ì†Œë“¤
        const tableBody = document.getElementById('status-body');
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error');
        const successElement = document.getElementById('success');
        const timestampElement = document.getElementById('timestamp');
        const refreshButton = document.getElementById('refresh-btn');

        /**
         * ìƒíƒœ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
         * @param {string} type - ë©”ì‹œì§€ íƒ€ì… ('loading', 'error', 'success')
         * @param {string} message - ë©”ì‹œì§€ ë‚´ìš©
         */
        function showMessage(type, message) {
            // ëª¨ë“  ë©”ì‹œì§€ ìš”ì†Œ ìˆ¨ê¸°ê¸°
            loadingElement.style.display = 'none';
            errorElement.style.display = 'none';
            successElement.style.display = 'none';

            // í•´ë‹¹ íƒ€ì…ì˜ ë©”ì‹œì§€ í‘œì‹œ
            switch (type) {
                case 'loading':
                    loadingElement.textContent = message;
                    loadingElement.style.display = 'block';
                    break;
                case 'error':
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                    break;
                case 'success':
                    successElement.textContent = message;
                    successElement.style.display = 'block';
                    break;
            }
        }

        /**
         * ë°ì´í„°ë¥¼ í…Œì´ë¸”ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
         * @param {Object} data - ìƒíƒœ ë°ì´í„°
         */
        function displayData(data) {
            tableBody.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°

            // ë°ì´í„°ë¥¼ ì‚¬ì´íŠ¸ ë³„ëª…(key) ìˆœì„œë¡œ ì •ë ¬í•˜ì—¬ í‘œì‹œ
            const sortedSiteIds = Object.keys(data).sort();

            if (sortedSiteIds.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            for (const siteId of sortedSiteIds) {
                const post = data[siteId];
                const row = `
                    <tr>
                        <td><strong>${siteId}</strong></td>
                        <td>${post.title || 'ì œëª© ì—†ìŒ'}</td>
                        <td>${post.no || 'ë²ˆí˜¸ ì—†ìŒ'}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            }
        }

        /**
         * APIì—ì„œ ìƒíƒœ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
         */
        async function fetchStatusData() {
            try {
                showMessage('loading', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
                refreshButton.disabled = true;

                console.log('API í˜¸ì¶œ ì‹œì‘:', statusApiUrl);

                const response = await fetch(statusApiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                console.log('API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('API ì‘ë‹µ ë°ì´í„°:', result);

                if (!result.success) {
                    throw new Error(result.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                // ë°ì´í„° í‘œì‹œ
                displayData(result.data);
                
                // íƒ€ì„ìŠ¤íƒ¬í”„ í‘œì‹œ
                if (result.timestamp) {
                    const date = new Date(result.timestamp);
                    timestampElement.textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${date.toLocaleString('ko-KR')}`;
                }

                showMessage('success', `âœ… ${Object.keys(result.data).length}ê°œ ì‚¬ì´íŠ¸ì˜ ìƒíƒœë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                
            } catch (error) {
                console.error('ìƒíƒœ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                showMessage('error', `âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            } finally {
                refreshButton.disabled = false;
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        refreshButton.addEventListener('click', fetchStatusData);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        window.addEventListener('load', fetchStatusData);

        // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨ (ì„ íƒì‚¬í•­)
        setInterval(() => {
            if (!refreshButton.disabled) {
                fetchStatusData();
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
